apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-configmap
  namespace: postgres
data:

  primary_init_script.sh: |
    #!/bin/bash
    set -e

    #This script assumes that the env-var $POSTGRES_MY_DB_PASSWORD contains the password of the custom user to create
    #You can add any env-var in your kubegres resource config YAML

    dt=$(date '+%Y-%m-%d %H:M:S');
    echo "$dt - Running init script the 1 st time Primary PostgreSql container is created";

    customDatabaseName="opematraw"
    customUserName="admin"
    customSchema="matcher"
    customRole="matcher"
    
    echo "$dt - Running: psql -v ON_ERROR_STOP=1 --username $POSTGRES_USER --dbname $POSTGRES_DB ...";

    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" << EOSQL

    CREATE DATABASE $customDatabaseName;
    \c $customDatabaseName;
    CREATE USER $customUserName;
    CREATE SCHEMA $customSchema;
    CREATE ROLE $customRole;

    GRANT CONNECT ON DATABASE $customDatabaseName TO $customUserName;
    GRANT CONNECT ON DATABASE $customDatabaseName TO $POSTGRES_USER;
    GRANT USAGE ON SCHEMA $customSchema TO $customUserName;
    GRANT ALL PRIVILEGES ON DATABASE $customDatabaseName to $customUserName;
    
    EOSQL

    echo "$dt - Init script is completed";